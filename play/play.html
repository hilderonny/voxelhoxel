<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="manifest" href="../manifest.json"/>
    <link rel="stylesheet" href="../shared/editor.css?v=201812152015"/>
    <script src="https://arrange.avorium.de/arrange-client.min.js"></script>
    <script src="../shared/three.js"></script>
    <script src="../shared/three.orbitcontrols.js"></script>
    <script src="../shared/utils.js?v=201812152015"></script>
    <script src="../shared/editor.js?v=201812152015"></script>
    <script src="../shared/localdb.js?v=201812152015"></script>
    <script>
      
      // Palette by Arne http://androidarts.com/palette/Famicube.htm
      const palette64 = [ '#000000', '#00177D', '#024ACA', '#0084FF', '#5BA8FF', '#98DCFF', '#9BA0EF', '#6264DC', '#3D34A5', '#211640', '#5A1991', '#6A31CA', '#A675FE', '#E2C9FF', '#FEC9ED', '#D59CFC', '#CC69E4', '#A328B3', '#871646', '#CF3C71', '#FF82CE', '#FFE9C5', '#F5B784', '#E18289', '#DA655E', '#823C3D', '#4F1507', '#E03C28', '#E2D7B5', '#C59782', '#AE6C37', '#5C3C0D', '#231712', '#AD4E1A', '#F68F37', '#FFE737', '#FFBB31', '#CC8F15', '#939717', '#B6C121', '#EEFFA9', '#BEEB71', '#8CD612', '#6AB417', '#376D03', '#172808', '#004E00', '#139D08', '#58D332', '#20B562', '#00604B', '#005280', '#0A98AC', '#25E2CD', '#BDFFCA', '#71A6A1', '#415D66', '#0D2030', '#151515', '#343434', '#7B7B7B', '#A8A8A8', '#D7D7D7', '#FFFFFF' ];
      const colorsLeft = {};
      var _id, model, colorBar;
      
      window.addEventListener('load', async function() {

        const renderer = Editor.init();
        document.getElementById("rendering").appendChild(renderer.domElement);
        
        _id = getRequestParameters()._id;
        if (!_id) return alert('Geht nicht ohne _id!');
        model = await LocalDb.loadModel(_id);
        if (!model) return alert('Kein passendes Modell gefunden!');
        
        document.getElementById('colorpalette').addEventListener('touchmove', function(e){e.stopPropagation()}, false);
        document.getElementById('colorbar').addEventListener('touchmove', function(e){e.stopPropagation()}, false);

        Editor.loadModel(model);
        
        createColorPalette();
        createColorBar();
        
        Editor.setMode('play');

        const selectedColorIndex = parseInt(Object.keys(colorsLeft)[0]);
        document.getElementsByName('color')[selectedColorIndex].checked = true;
        selectColor(selectedColorIndex);

        Editor.start();
        
      });
      
      document.addEventListener('painted', function(evt) {
        const mesh = evt.detail;
        const colorIndex = mesh.paletteNumber;
        colorsLeft[colorIndex]--;
        checkColor(colorIndex);
        document.getElementById("colorcounternumber").innerHTML = colorsLeft[colorIndex];
      });
      
      function checkAllColors() {
        const painted = model.painted;
        Object.keys(painted).forEach(function(zKey) {
          const bz = painted[zKey];
          Object.keys(bz).forEach(function(yKey) {
            const by = bz[yKey];
            Object.keys(by).forEach(function(xKey) {
              const colorIndex = model.scene[zKey][yKey][xKey];
              colorsLeft[colorIndex]--;
              if (colorsLeft[colorIndex] < 1) checkColor(colorIndex);
            });
          });
        });
      }
      
      function checkColor(colorIndex) {
        if (colorsLeft[colorIndex] < 1) {
          document.getElementsByName('color')[colorIndex].classList.add('complete');
          if (Object.values(colorsLeft).reduce(function(pv, cv) { return pv + cv; }, 0) < 1) {
            model.complete = true;
            document.getElementById('complete').style.display = 'block';
          }
        }
      }
      
      async function clearPainted() {
        if (!confirm('Soll das Modell wirklich geleert werden?')) return;
        model.painted = {};
        delete model.complete;
        checkAllColors();
        await LocalDb.saveModel(model);
        location.reload();
      }
      
      function createColorBar() {
        colorBar = document.getElementById('colorbar');
        const scene = model.scene;
        Object.keys(scene).forEach(function(zKey) {
          const bz = scene[zKey];
          Object.keys(bz).forEach(function(yKey) {
            const by = bz[yKey];
            Object.keys(by).forEach(function(xKey) {
              const actualValue = colorsLeft[by[xKey]];
              colorsLeft[by[xKey]] = (actualValue ? actualValue : 0) + 1;
            });
          });
        });
        model.colorpalette.forEach(function(color, index) {
          colorBar.innerHTML += '<label' + (colorsLeft[index] ? '' : ' class="invisible"') + '><input type="radio" name="color" onchange="selectColor(' + index + ');" /><div style="background-color:' + color + '"><span class="unchecked">' + index + '</span><img class="checked" src="../images/checkmark.png"/></div></label>';
        });
        checkAllColors();
      }
      
      function createColorPalette() {
        const colorPalette = document.getElementById('colorpalette');
        palette64.forEach(function(color, index) {
          colorPalette.innerHTML += '<label><input type="radio" name="colorpalette"' + (index === 0 ? ' checked' : '') + ' onchange="setPaletteColor(' + index + ');" /><div style="background-color:' + color + '"></div></label>';
        });
      }
      
      async function goBack() {
        model.thumbnail = Editor.makeScreenshot();
        await LocalDb.saveModel(model);
        location.href = 'index.html';
      }
      
      function selectColor(colorIndex) {
        Editor.selectColor(colorIndex);
        document.getElementById("colorcounternumber").innerHTML = colorsLeft[colorIndex];
        document.getElementById("colorcounterblock").style.backgroundColor = model.colorpalette[colorIndex];
      }
      
      async function setPaletteColor(paletteIndex) {
        const color = palette64[paletteIndex];
        document.getElementsByName('color').forEach(function(input) { 
          if (!input.checked) return;
          input.nextElementSibling.style.backgroundColor = color;
        });
        Editor.setCurrentColor(color);
        document.getElementById("colorcounterblock").style.backgroundColor = color;
      }
      
      function toggleColorPalette() {
        document.getElementById('colorpalette').classList.toggle('visible');
        Editor.forceResize();
      }
      
    </script>
  </head>
  <body>
    
    <div id="rendering">
      <div class="colorcounter"><div id="colorcounterblock"></div><div id="colorcounternumber"></div></div>
      <img id="complete" src="../images/complete.png" />
    </div>
    
    <div id="toolbar">
      <img onclick="toggleColorPalette();" src="../images/palette.png"/>
      <div class="spacer"></div>
      <img onclick="clearPainted();" src="../images/clear.png"/>
    </div>
    
    <div id="colorpalette"></div>
    
    <div id="colorbar"></div>
    
    <div id="toptoolbar">
      <img onclick="goBack();" src="../images/back.png" />
    </div>
    
  </body>
</html>
