<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../manifest.json"/>
    <link rel="stylesheet" href="../shared/list.css"/>
    <script src="https://arrange.avorium.de/arrange-client.min.js"></script>
    <script src="../shared/localdb.js"></script>
    <script>
      
      var localModels;
      
      window.addEventListener('load', async function() {
        
        localModels = await LocalDb.listModels();

        try {
          const arrangeClient = await ArrangeClient().connect('wss://arrange.avorium.de:42001');
          const modelsFromServer = await arrangeClient.search('voxelhoxel', 'models', { isPublished: true }, '_id version');
          // Save models in local database
          for (var i = 0; i < modelsFromServer.length; i++) {
            const model = modelsFromServer[i];
            const localModelIndex = localModels.findIndex(function(m) { return m._id === model._id });
            if (localModelIndex < 0) {
              const modelFromServer = await arrangeClient.read('voxelhoxel', 'models', model._id);
              LocalDb.saveModel(modelFromServer);
              localModels.push(modelFromServer);
            } else {
              const localModel = localModels[localModelIndex];
              if (Object.keys(localModel.painted).length < 1 && (!localModel.version || model.version > localModel.version)) {
                const modelFromServer = await arrangeClient.read('voxelhoxel', 'models', model._id);
                LocalDb.saveModel(modelFromServer);
                localModels[localModelIndex] = modelFromServer;
              }
            }
          }
        } catch(ex) {
          console.log('We are offline because ', ex);
        }
        
        const list = document.querySelector('.list');
        localModels.sort(function(a, b) { 
          if (a.complete && !b.complete) return 1;
          if (!a.complete && b.complete) return -1;
          return 0;
        });
        localModels.forEach(function(model) {
          const el = document.createElement('div');
          if (Object.keys(model.painted).length < 1) {
            el.innerHTML = '<img src="' + model.thumbnail + '" style="filter:grayscale(100%);"/><span class="new">Neu</span>';
          } else {
            el.innerHTML = '<img src="' + model.thumbnail + '"/>' + (model.complete ? '<span class="complete">&#10004;</span>' : '');
          }
          el.addEventListener('click', function() {
            location.href = 'play.html?_id=' + model._id;
          });
          list.appendChild(el);
        });
        
      });
    </script>
  </head>
  <body>
    <div class="list"></div>
  </body>
</html>
